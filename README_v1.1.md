# Excel構造分析ツール（修正版）

ExcelファイルをLLMで分析し、テーブル形式の判別とヘッダー検出を行うStreamlitアプリケーションです。

## 修正内容（v1.1）

### 🔧 修正された問題
- **APIキーテスト失敗の問題を解決**: 詳細なエラーメッセージを表示するように改善
- **LLMモデルをgpt-4.1-miniに変更**: より高精度な分析を実現
- **JSON応答パースエラーを修正**: LLMが返すマークダウンコードブロック（```json）を適切に処理

### 🚀 改善点
- より詳細なエラーハンドリング（認証エラー、レート制限エラーなど）
- LLM応答の前処理によるパース成功率の向上
- APIキーテスト時の具体的なエラー原因の表示

## 機能

- **Excelファイルアップロード**: .xlsx, .xls形式のファイルに対応
- **基本構造分析**: シートの行数、列数、データ密度、結合セルの数などを分析
- **LLM分析**: OpenAI GPT-4.1-miniを使用してシートの分類とヘッダー検出を実行
- **型安全な出力**: Pydanticモデルを使用した構造化された分析結果
- **pandas読み込み例の提示**: 検出されたヘッダー情報に基づくpandasコードの自動生成

## シート分類

- **table**: データが行列形式で整理されており、明確なヘッダーがある
- **form**: 入力フォームのような構造で、ラベルと値のペアが散在している
- **mixed**: テーブル要素とフォーム要素が混在している
- **unknown**: 上記のいずれにも明確に分類できない

## ヘッダー検出

- **single**: 単一行のヘッダー
- **multi-level**: 複数行にわたる複合ヘッダー（結合セルを含む）

## ファイル構成

```
excel_analyzer/
├── app.py                 # Streamlitメインアプリケーション（修正版）
├── models.py              # Pydanticモデル定義
├── excel_utils.py         # Excel解析ユーティリティ
├── llm_api.py            # LLM API呼び出し機能（修正版）
├── create_samples.py      # サンプルファイル作成スクリプト
├── requirements.txt       # 必要なパッケージ
├── sample_single_header.xlsx    # サンプル: 単一ヘッダーテーブル
├── sample_multi_header.xlsx     # サンプル: 複合ヘッダーテーブル
└── sample_form.xlsx            # サンプル: フォーム形式
```

## セットアップ

1. 必要なパッケージをインストール:
```bash
pip install -r requirements.txt
```

2. Streamlitアプリケーションを起動:
```bash
streamlit run app.py
```

3. ブラウザでアプリケーションにアクセス（通常は http://localhost:8501）

## 使用方法

1. **APIキーの設定**: サイドバーでOpenAI APIキーを入力
2. **APIキーのテスト**: 「APIキーをテスト」ボタンで接続確認（詳細なエラー情報を表示）
3. **ファイルアップロード**: Excelファイルを選択してアップロード
4. **基本分析の確認**: アップロード後、基本的な構造情報を確認
5. **LLM分析の実行**: 「LLM分析を実行」ボタンをクリック
6. **結果の確認**: 分析結果とpandas読み込み例を確認

## トラブルシューティング

### APIキーテストが失敗する場合

修正版では、以下のような詳細なエラーメッセージが表示されます：

- **認証エラー**: `APIキーが無効です` - APIキーを確認してください
- **レート制限エラー**: `レート制限に達しました` - しばらく待ってから再試行してください
- **APIエラー**: `OpenAI APIエラー` - サービスの状態を確認してください

### よくある問題と解決方法

1. **APIキーが無効**: OpenAIのダッシュボードで正しいAPIキーを確認
2. **モデルアクセス権限**: gpt-4.1-miniへのアクセス権限があることを確認
3. **ネットワーク接続**: インターネット接続を確認

## サンプルファイル

テスト用に3つのサンプルファイルが含まれています：

### sample_single_header.xlsx
単一行のヘッダーを持つテーブル形式のデータ
```
| ID | 商品名 | 価格 | 在庫数 |
|----|--------|------|--------|
| 1  | りんご | 100  | 50     |
| 2  | みかん | 80   | 30     |
```

### sample_multi_header.xlsx
複数行にわたる複合ヘッダーを持つテーブル
```
| 地域   | 商品名 | 売上     |
|        |        | Q1 | Q2 |
|--------|--------|----|----|
| 北海道 | りんご | 100| 120|
| 東京   | みかん | 150| 130|
```

### sample_form.xlsx
フォーム形式のレイアウト
```
顧客情報入力フォーム

顧客ID:      C001
会社名:      株式会社サンプル
担当者名:    田中太郎
```

## 技術仕様

- **フロントエンド**: Streamlit
- **Excel処理**: openpyxl, pandas
- **LLM**: OpenAI GPT-4.1-mini（修正版で変更）
- **データ検証**: Pydantic
- **Python**: 3.11+

## 出力形式

LLM分析の結果は以下のJSON構造で返されます：

```json
{
  "sheets": [
    {
      "sheet_name": "シート名",
      "sheet_type": "table|form|mixed|unknown",
      "header_info": {
        "start_row": 1,
        "end_row": 2,
        "header_type": "single|multi-level"
      },
      "reasoning": "判定理由の説明"
    }
  ]
}
```

## 変更履歴

### v1.1 (修正版)
- LLMモデルをgpt-4o-miniからgpt-4.1-miniに変更
- APIキーテストの詳細なエラーハンドリングを追加
- LLM応答のマークダウンコードブロック除去処理を追加
- より具体的なエラーメッセージの表示

### v1.0 (初期版)
- 基本的なExcel分析機能
- Streamlit UI
- Pydanticによる型安全な出力

## 注意事項

- OpenAI APIキーが必要です
- gpt-4.1-miniへのアクセス権限が必要です
- 大きなExcelファイル（20行以上）の場合、最初の20行のみがLLM分析の対象となります
- APIの利用には料金が発生する場合があります
- インターネット接続が必要です

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。

