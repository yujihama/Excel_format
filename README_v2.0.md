# Excel構造分析ツール（マルチモーダル対応版 v2.0）

ExcelファイルをLLMで分析し、テーブル形式の判別とヘッダー検出を行うStreamlitアプリケーションです。

## 新機能（v2.0）

### 🖼️ LibreOffice画像キャプチャ機能
- **視覚的分析**: LibreOfficeでExcelファイルの画像キャプチャを自動取得
- **マルチモーダルLLM**: テキスト情報と画像の両方を使用した高精度分析
- **ヘッダー検出精度向上**: 視覚的なフォーマット（太字、色、レイアウト）を考慮した分析

### 🔧 技術的改善
- **gpt-4.1-mini**: 最新のマルチモーダルLLMモデルを使用
- **自動画像変換**: LibreOffice → PDF → PNG の自動変換パイプライン
- **エラーハンドリング**: 画像取得失敗時の自動フォールバック

## 機能

### 基本機能
- **Excelファイルアップロード**: .xlsx, .xls形式のファイルに対応
- **基本構造分析**: シートの行数、列数、データ密度、結合セルの数などを分析
- **型安全な出力**: Pydanticモデルを使用した構造化された分析結果
- **pandas読み込み例の提示**: 検出されたヘッダー情報に基づくpandasコードの自動生成

### 新機能（マルチモーダル分析）
- **画像キャプチャ**: LibreOfficeを使用したExcelファイルの視覚的キャプチャ
- **マルチモーダルLLM分析**: テキスト + 画像による高精度分析
- **視覚的ヘッダー検出**: フォント、色、レイアウトを考慮したヘッダー判別
- **分析方法選択**: 画像キャプチャの有効/無効を選択可能

## シート分類

- **table**: データが行列形式で整理されており、明確なヘッダーがある
- **form**: 入力フォームのような構造で、ラベルと値のペアが散在している
- **mixed**: テーブル要素とフォーム要素が混在している
- **unknown**: 上記のいずれにも明確に分類できない

## ヘッダー検出

- **single**: 単一行のヘッダー
- **multi-level**: 複数行にわたる複合ヘッダー（結合セルを含む）

## ファイル構成

```
excel_analyzer/
├── app.py                      # Streamlitメインアプリケーション（v2.0）
├── models.py                   # Pydanticモデル定義
├── excel_utils.py              # Excel解析ユーティリティ
├── llm_api.py                 # LLM API呼び出し機能（マルチモーダル対応）
├── libreoffice_capture.py     # LibreOffice画像キャプチャ機能（新規）
├── create_samples.py           # サンプルファイル作成スクリプト
├── requirements.txt            # 必要なパッケージ
├── sample_single_header.xlsx   # サンプル: 単一ヘッダーテーブル
├── sample_multi_header.xlsx    # サンプル: 複合ヘッダーテーブル
└── sample_form.xlsx           # サンプル: フォーム形式
```

## セットアップ

### 1. システム要件
```bash
# LibreOfficeとXvfbをインストール
sudo apt update
sudo apt install -y libreoffice-calc xvfb poppler-utils
```

### 2. Pythonパッケージのインストール
```bash
pip install -r requirements.txt
```

### 3. アプリケーションの起動
```bash
streamlit run app.py
```

## 使用方法

### 基本的な使用手順
1. **APIキーの設定**: サイドバーでOpenAI APIキーを入力
2. **APIキーのテスト**: 「APIキーをテスト」ボタンで接続確認
3. **ファイルアップロード**: Excelファイルを選択してアップロード
4. **分析オプション選択**: 
   - ✅ LibreOfficeで画像キャプチャを取得（推奨）
   - ❌ テキスト分析のみ
5. **LLM分析の実行**: 「LLM分析を実行」ボタンをクリック
6. **結果の確認**: 分析結果、画像キャプチャ、pandas読み込み例を確認

### 分析方法の比較

| 分析方法 | 精度 | 処理時間 | 検出可能な要素 |
|----------|------|----------|----------------|
| **マルチモーダル（推奨）** | ⭐⭐⭐⭐⭐ | やや長い | テキスト + 視覚的フォーマット |
| **テキストのみ** | ⭐⭐⭐ | 短い | テキスト内容のみ |

## 技術仕様

- **フロントエンド**: Streamlit
- **Excel処理**: openpyxl, pandas
- **LLM**: OpenAI GPT-4.1-mini（マルチモーダル対応）
- **画像処理**: LibreOffice, poppler-utils, pdf2image
- **データ検証**: Pydantic
- **Python**: 3.11+

## サンプルファイル

### sample_single_header.xlsx
単一行のヘッダーを持つテーブル形式のデータ

**テキスト表現:**
```
row1: | **ID** | **商品名** | **価格** | **在庫数** |
row2: | 1 | りんご | 100 | 50 |
```

**画像キャプチャ:**
- 視覚的にヘッダー行が強調表示されている
- 列の境界が明確に表示されている

### sample_multi_header.xlsx
複数行にわたる複合ヘッダーを持つテーブル

**特徴:**
- 結合セルを使用した階層構造
- 視覚的なヘッダーグループ化

### sample_form.xlsx
フォーム形式のレイアウト

**特徴:**
- ラベルと値のペア構造
- 非表形式のレイアウト

## 出力形式

LLM分析の結果は以下のJSON構造で返されます：

```json
{
  "sheets": [
    {
      "sheet_name": "シート名",
      "sheet_type": "table|form|mixed|unknown",
      "header_info": {
        "start_row": 1,
        "end_row": 2,
        "header_type": "single|multi-level"
      },
      "reasoning": "判定理由の説明（画像情報を含む）"
    }
  ]
}
```

## トラブルシューティング

### 画像キャプチャ関連

**問題**: 画像キャプチャの取得に失敗する
**解決方法**:
1. LibreOfficeがインストールされているか確認: `libreoffice --version`
2. Xvfbがインストールされているか確認: `which Xvfb`
3. 権限の問題: `/tmp`ディレクトリの書き込み権限を確認

**問題**: PDFから画像への変換に失敗する
**解決方法**:
1. poppler-utilsがインストールされているか確認: `which pdftoppm`
2. pdf2imageライブラリのインストール: `pip install pdf2image`

### LLM分析関連

**問題**: マルチモーダル分析でエラーが発生する
**解決方法**:
1. gpt-4.1-miniへのアクセス権限を確認
2. 画像サイズが大きすぎる場合は解像度を下げる
3. 画像キャプチャを無効にしてテキスト分析のみで試行

## パフォーマンス

### 処理時間の目安
- **画像キャプチャ取得**: 5-10秒
- **マルチモーダルLLM分析**: 10-20秒
- **テキストのみLLM分析**: 3-5秒

### リソース使用量
- **メモリ**: 約500MB（LibreOffice起動時）
- **ディスク**: 一時ファイル用に約10MB

## 変更履歴

### v2.0 (マルチモーダル対応版)
- LibreOffice画像キャプチャ機能を追加
- マルチモーダルLLM分析に対応
- 視覚的ヘッダー検出の精度向上
- 分析オプション選択機能を追加

### v1.1 (修正版)
- LLMモデルをgpt-4.1-miniに変更
- APIキーテストの詳細なエラーハンドリングを追加
- LLM応答のマークダウンコードブロック除去処理を追加

### v1.0 (初期版)
- 基本的なExcel分析機能
- Streamlit UI
- Pydanticによる型安全な出力

## 注意事項

- OpenAI APIキーが必要です
- gpt-4.1-miniへのアクセス権限が必要です
- LibreOfficeとXvfbのインストールが必要です
- 大きなExcelファイル（20行以上）の場合、最初の20行のみがLLM分析の対象となります
- APIの利用には料金が発生する場合があります
- インターネット接続が必要です

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。

